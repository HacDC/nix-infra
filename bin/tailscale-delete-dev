#!/usr/bin/env bash
set -e

hostname="$1"

api="https://api.tailscale.com/api/v2"
auth="$TAILSCALE_API_KEY:"

url="$api/tailnet/$TAILSCALE_EMAIL/devices"
jq_select=".devices[] | select(.name == \"$hostname.$TAILSCALE_NET\") | .id"
device_id="$(curl -s -u "$auth" "$url" | jq -r "$jq_select")"
if [ -z "$device_id" ]; then
    echo "device did not exist"
    exit 0
fi

curl -s -u "$auth" -X DELETE "$api/device/$device_id" 
